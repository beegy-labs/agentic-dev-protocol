name: Propagate Standards to Projects

on:
  push:
    branches:
      - main
    paths:
      - 'AGENTS.md'
      - 'docs/llm/policies/**'
      - '.ai/README.md'
      - 'docs/llm/README.md'
      - '.specs/README.md'
      - 'projects.json'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (report only, no changes)'
        required: false
        type: boolean
        default: false

jobs:
  propagate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout llm-dev-protocol
        uses: actions/checkout@v4
        with:
          path: llm-dev-protocol

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Load projects configuration
        id: config
        run: |
          cd llm-dev-protocol
          echo "projects=$(jq -c '.projects[] | select(.enabled == true)' projects.json | jq -s -c .)" >> $GITHUB_OUTPUT

      - name: Propagate to each project
        env:
          PROJECTS: ${{ steps.config.outputs.projects }}
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          cd llm-dev-protocol
          echo "$PROJECTS" | jq -c '.[]' | while read project; do
            PROJECT_NAME=$(echo $project | jq -r '.name')
            PROJECT_PATH=$(echo $project | jq -r '.path')

            echo "Processing: $PROJECT_NAME"

            # Resolve absolute path
            ABS_PATH=$(realpath "$PROJECT_PATH" 2>/dev/null || echo "")

            if [ -z "$ABS_PATH" ] || [ ! -d "$ABS_PATH" ]; then
              echo "⚠️  Project not found: $PROJECT_PATH"
              continue
            fi

            echo "  Path: $ABS_PATH"

            # Sync AGENTS.md (marker-based - preserves PROJECT CUSTOM section)
            if [ "$DRY_RUN" = "true" ]; then
              echo "  [DRY RUN] Would sync: AGENTS.md (marker-based)"
            else
              bash scripts/sync-agents-md.sh AGENTS.md "$ABS_PATH/AGENTS.md"
              echo "  ✓ Synced: AGENTS.md (custom section preserved)"
            fi

            # Sync policy files (force sync - always overwrite)
            SYNC_FILES=$(echo $project | jq -r '.sync | to_entries[] | select(.value == true) | .key')
            for file in $SYNC_FILES; do
              if [ -f "$file" ]; then
                TARGET_DIR=$(dirname "$ABS_PATH/$file")
                mkdir -p "$TARGET_DIR"

                if [ "$DRY_RUN" = "true" ]; then
                  echo "  [DRY RUN] Would sync: $file"
                else
                  cp -f "$file" "$ABS_PATH/$file"
                  echo "  ✓ Synced: $file"
                fi
              fi
            done

            # Sync CDD scripts (force sync - always overwrite)
            CDD_SCRIPTS=$(jq -r '.sync_rules.cdd_scripts[]' projects.json 2>/dev/null || echo "")
            for script in $CDD_SCRIPTS; do
              if [ -f "$script" ]; then
                TARGET_DIR=$(dirname "$ABS_PATH/$script")
                mkdir -p "$TARGET_DIR"

                if [ "$DRY_RUN" = "true" ]; then
                  echo "  [DRY RUN] Would sync: $script"
                else
                  cp -f "$script" "$ABS_PATH/$script"
                  chmod +x "$ABS_PATH/$script"
                  echo "  ✓ Synced: $script"
                fi
              fi
            done

            # Sync optional files (only if missing - initial setup only)
            OPTIONAL_FILES=$(jq -r '.sync_rules.optional_files.files[]' projects.json 2>/dev/null || echo "")
            for file in $OPTIONAL_FILES; do
              if [ -f "$file" ] && [ ! -f "$ABS_PATH/$file" ]; then
                TARGET_DIR=$(dirname "$ABS_PATH/$file")
                mkdir -p "$TARGET_DIR"

                if [ "$DRY_RUN" = "true" ]; then
                  echo "  [DRY RUN] Would copy (initial): $file"
                else
                  cp "$file" "$ABS_PATH/$file"
                  echo "  ✓ Copied (initial): $file"
                fi
              fi
            done

            # Validate structure
            if [ -f "scripts/validate-structure.sh" ]; then
              echo "  Running structure validation..."
              bash scripts/validate-structure.sh "$ABS_PATH" --quiet || echo "  ⚠️  Validation warnings"
            fi

            echo "  ✓ Completed: $PROJECT_NAME"
            echo ""
          done

      - name: Create summary
        run: |
          echo "## Propagation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Successfully propagated standards to configured projects." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Synced Files" >> $GITHUB_STEP_SUMMARY
          echo "- AGENTS.md" >> $GITHUB_STEP_SUMMARY
          echo "- docs/llm/policies/*.md" >> $GITHUB_STEP_SUMMARY
