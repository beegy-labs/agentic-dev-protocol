name: Sync Standards to Projects

on:
  push:
    branches:
      - main
    paths:
      - 'AGENTS.md'
      - 'standards/**'
      - 'docs/llm/policies/**'
      - 'templates/**'

  workflow_dispatch:
    inputs:
      target_project:
        description: 'Target project to sync (leave empty for all)'
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout llm-dev-protocol
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Read projects configuration
        id: projects
        run: |
          if [ -f projects.json ]; then
            echo "Projects configuration found"
            cat projects.json
          else
            echo "No projects.json found"
            exit 1
          fi

      - name: Sync AGENTS.md to my-girok
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          # Clone my-girok repository
          REPO_URL="${{ secrets.MY_GIROK_REPO_URL }}"

          if [ -z "$REPO_URL" ]; then
            echo "MY_GIROK_REPO_URL secret not set, using default"
            REPO_URL="https://github.com/beegy-labs/my-girok.git"
          fi

          git clone $REPO_URL my-girok-temp
          cd my-girok-temp

          # Create new branch
          BRANCH_NAME="sync/llm-dev-protocol-$(date +%Y%m%d-%H%M%S)"
          git checkout -b $BRANCH_NAME

          # Sync AGENTS.md (marker-based)
          echo "Syncing AGENTS.md..."

          # Extract STANDARD POLICY section from llm-dev-protocol
          sed -n '/<!-- BEGIN: STANDARD POLICY -->/,/<!-- END: STANDARD POLICY -->/p' ../AGENTS.md > /tmp/standard_section.md

          # Replace in my-girok AGENTS.md
          if [ -f AGENTS.md ]; then
            # Keep everything before BEGIN marker
            sed -n '1,/<!-- BEGIN: STANDARD POLICY -->/p' AGENTS.md > /tmp/agents_new.md

            # Add new standard section
            cat /tmp/standard_section.md >> /tmp/agents_new.md

            # Add everything after END marker
            sed -n '/<!-- END: STANDARD POLICY -->/,$p' AGENTS.md | tail -n +2 >> /tmp/agents_new.md

            mv /tmp/agents_new.md AGENTS.md

            echo "AGENTS.md updated"
          else
            echo "AGENTS.md not found in my-girok, creating new"
            cp ../AGENTS.md AGENTS.md
          fi

          # Check if there are changes
          if git diff --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          # Commit and push
          git config user.name "LLM Dev Protocol Bot"
          git config user.email "bot@llm-dev-protocol.dev"
          git add AGENTS.md
          git commit -m "sync: Update AGENTS.md from llm-dev-protocol

Automated sync from llm-dev-protocol repository.

Changes:
- Updated STANDARD POLICY section
- Preserved PROJECT CUSTOM section

Co-Authored-By: LLM Dev Protocol Bot <bot@llm-dev-protocol.dev>"

          # Push and create PR
          git push origin $BRANCH_NAME

          # Create PR using GitHub CLI
          gh pr create \
            --title "sync: Update AGENTS.md from llm-dev-protocol" \
            --body "## Automated Sync

This PR updates AGENTS.md with the latest standard policy from llm-dev-protocol.

### Changes
- Updated STANDARD POLICY section
- PROJECT CUSTOM section preserved

### Verification
- [ ] STANDARD POLICY section matches llm-dev-protocol
- [ ] PROJECT CUSTOM section unchanged
- [ ] No merge conflicts

**Auto-generated by**: llm-dev-protocol CI/CD" \
            --base main \
            --head $BRANCH_NAME

      - name: Sync standards to my-girok
        env:
          GH_TOKEN: ${{ secrets.SYNC_TOKEN }}
        run: |
          cd my-girok-temp

          # Create docs/llm/policies if not exists
          mkdir -p docs/llm/policies

          # Copy policy files (if they don't exist in my-girok)
          for policy in cdd sdd add; do
            if [ ! -f "docs/llm/policies/${policy}.md" ]; then
              echo "Creating docs/llm/policies/${policy}.md"
              cp "../standards/${policy}/README.md" "docs/llm/policies/${policy}.md"
              git add "docs/llm/policies/${policy}.md"
            fi
          done

          # Commit if there are new files
          if ! git diff --cached --quiet; then
            git commit -m "docs: Add missing policy files from llm-dev-protocol

Co-Authored-By: LLM Dev Protocol Bot <bot@llm-dev-protocol.dev>"
            git push origin $BRANCH_NAME
          fi

      - name: Notify on Slack (Optional)
        if: always()
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST $SLACK_WEBHOOK \
              -H 'Content-Type: application/json' \
              -d '{
                "text": "llm-dev-protocol synced to my-girok",
                "blocks": [
                  {
                    "type": "section",
                    "text": {
                      "type": "mrkdwn",
                      "text": "*llm-dev-protocol* standards synced to *my-girok*\n\nStatus: ${{ job.status }}"
                    }
                  }
                ]
              }'
          fi
